<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>By Cooked</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="./css/dash.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="./js/sessao.js"></script>

</head>

<body onload="validarSessao(), obterDadosGraficoPizza(idUsuario), obterDadosGraficoTopReceitas(), carregarKPIs()">
    <header>
        <div class="logo">By Cooked</div>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="salgados.html">Receitas salgadas</a></li>
                <li><a href="doces.html">Receitas doces</a></li>
                <li><a href="vegetariana.html">Receitas vegetarianas</a></li>
                <p>|</p>
                <li><a href="dashboard.html">üßëüèª‚Äçüç≥ Usu√°rio</a></li>
            </ul>
        </nav>
    </header>

    <div class="conteudo-dashboard">

        <div class="coluna-esquerda">
            <div id="receitasFavoritas">
                <h2>Minhas Receitas Favoritas:</h2>
                <div onclick="irFavoritas()" class="containerFav">
                    <img src="./img/div_fav.jpeg" alt="bolo">
                    <p>Receitas Favoritadas ‚ù§Ô∏è</p>
                    <h5>Clique aqui para ver suas receitas favoritas!</h5>
                </div>
            </div>
        </div>


        <div class="coluna-direita">
            <h2>Meus Indicadores:</h2><br>
            <div class="kpis">
                <div class="kpi">
                    <h3>N¬∞ Receitas Favoritadas</h3>
                    <p id="kpi-favoritadas"></p>
                </div>
                <div class="kpi">
                    <h3>N√≠vel de Usu√°rio</h3>
                    <p id="kpi-nivel"></p>
                </div>
                <div class="kpi">
                    <h3>Tipo Preferido</h3>
                    <p id="kpi-tipo"></p>
                </div>
            </div>

            <div class="graficos">
                <div class="graficoPie">
                    <canvas id="graficoPizza"></canvas>
                </div>

                <div class="graficoTop">
                    <canvas class="topReceitas" id="graficoTopReceitas"></canvas>
                </div>
            </div>
        </div>
    </div>

</body>

<script>

    var idUsuario = sessionStorage.ID_USUARIO;

    function irFavoritas() {
        window.location.href = "./favoritas.html";
    }

    // KPIS 
    function carregarKPIs() {
        // KPI 1 
        fetch(`/graficos/favoritas-usuario/${idUsuario}`)
            .then(function (resposta) {
                return resposta.json();
            })
            .then(function (dados) {
                var total = dados.total;
                document.getElementById("kpi-favoritadas").innerText = total;

                // KPI 2
                var nivel = "Iniciante üç≥";
                if (total >= 5 && total < 10) {
                    nivel = "Intermedi√°rio ü´ï";
                } else if (total >= 10) {
                    nivel = "Chef de Cozinha üßë‚Äçüç≥ ";
                }
                document.getElementById("kpi-nivel").innerText = nivel;
            })
            .catch(function (erro) {
                console.error("Erro:", erro);
            });


        // KPI 3 
        fetch(`/graficos/tipo-preferido/${idUsuario}`)
            .then(function (resposta) {
                return resposta.json();
            })
            .then(function (dados) {
                document.getElementById("kpi-tipo").innerText = dados.tipo;
            })
            .catch(function (erro) {
                console.error("Erro:", erro);
            });

    }


    // Obtendo Dados...

    function obterDadosGraficoPizza(idUsuario) {

        fetch(`/graficos/grafico-pizza/${idUsuario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log("Dados recebidos para gr√°fico de pizza:");
                    console.log(resposta);

                    plotarGraficoPizza(resposta);
                });
            } else {
                console.error("Nenhum dado encontrado ou erro na API (pizza)");
            }
        }).catch(function (erro) {
            console.error("Erro:", erro);
        });
    }

    // Gr√°fico Pizza - tipos receita.

    function plotarGraficoPizza(dadosRecebidos) {
        console.log("Iniciando plotagem do gr√°fico de pizza...");

        var labels = [];
        var valores = [];

        for (var i = 0; i < dadosRecebidos.length; i++) {
            var item = dadosRecebidos[i];
            labels.push(item.tipo);
            valores.push(item.total);
        }

        console.log("Labels:");
        console.log(labels);
        console.log("Valores:");
        console.log(valores);

        var dados = {
            labels: labels,
            datasets: [{
                data: valores,
                backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56"],
                borderColor: "white",
                borderWidth: 2
            }]
        };

        var config = {
            type: "pie",
            data: dados,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: "bottom"
                    },
                    title: {
                        display: true,
                        text: "Suas Receitas Favoritadas por Tipo"
                    }
                }
            }
        };

        var meuGrafico = new Chart(
            document.getElementById("graficoPizza"),
            config
        );
    }

    // Obtendo os dadinhos...

    function obterDadosGraficoTopReceitas() {

        fetch(`/graficos/grafico-top-receitas`, { cache: 'no-store' })
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log("Dados recebidos para gr√°fico Top Receitas:");
                        console.log(resposta);

                        plotarGraficoTopReceitas(resposta);
                    });
                } else {
                    console.error("Erro ao buscar dados do gr√°fico Top Receitas.");
                }
            })
            .catch(function (erro) {
                console.error("Erro:", erro);
            });
    }
    // Gr√°fico - Ranking 3 receitas mais favoritadas.

    function plotarGraficoTopReceitas(dadosRecebidos) {
        console.log("Iniciando plotagem do gr√°fico Top Receitas...");

        var labels = [];
        var valores = [];

        for (var i = 0; i < dadosRecebidos.length; i++) {
            var item = dadosRecebidos[i];
            labels.push(item.nome);
            valores.push(item.total);
        }

        console.log("Labels:");
        console.log(labels);
        console.log("Valores:");
        console.log(valores);

        var dados = {
            labels: labels,
            datasets: [{
                label: 'Top Receitas Favoritadas',
                data: valores,
                backgroundColor: '#FF6384',
                borderColor: '#c0264b',
                borderWidth: 1
            }]
        };

        var config = {
            type: 'bar',
            data: dados,
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Top 3 Receitas Favoritadas do Site'
                    }
                }
            }
        };

        var meuGrafico = new Chart(
            document.getElementById("graficoTopReceitas"),
            config
        );
    }

</script>

</html>